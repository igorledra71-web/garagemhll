<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* ====== COLE AQUI SUA firebaseConfig ====== */
const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_AUTH_DOMAIN",
  projectId: "SEU_PROJECT_ID",
  storageBucket: "SEU_STORAGE_BUCKET",
  messagingSenderId: "SEU_MESSAGING_ID",
  appId: "SEU_APP_ID"
};
/* ======================================== */

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const horariosBase = ["08:00","09:00","10:00","11:00","13:00","14:00","15:00","16:00","17:00"];

let carrinho = [];
let total = 0;

window.openScreen = function(id){
  document.querySelectorAll(".screen").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
};

window.add = function(nome,valor){
  carrinho.push({nome,valor});
  total += valor;
  atualizarCarrinho();
  document.getElementById("cart").style.display="block";
};

window.remover = function(i){
  total -= carrinho[i].valor;
  carrinho.splice(i,1);
  atualizarCarrinho();
  if(carrinho.length===0){
    document.getElementById("cart").style.display="none";
  }
};

function atualizarCarrinho(){
  let html="";
  carrinho.forEach((item,i)=>{
    html += `<div class="cart-item">${item.nome} <span class="remove" onclick="remover(${i})">❌</span></div>`;
  });
  document.getElementById("itens").innerHTML = html;
  document.getElementById("total").innerText = total.toFixed(2);
}

window.whats = function(){
  let texto="Olá, gostaria de agendar:%0A";
  carrinho.forEach(i=>{ texto += "- "+i.nome+"%0A"; });
  texto += "%0ATotal: R$ "+total.toFixed(2);
  window.open("https://wa.me/5547991194498?text="+texto,"_blank");
};

/* ====== AGENDAMENTO GLOBAL ====== */

const dataInput = document.getElementById("data");
const horaSelect = document.getElementById("hora");

dataInput.addEventListener("change", carregarHorarios);

async function carregarHorarios(){
  const data = dataInput.value;
  horaSelect.innerHTML = "";

  if(!data){
    horaSelect.innerHTML = "<option>Selecione a data</option>";
    return;
  }

  const ref = doc(db, "reservas", data);

  onSnapshot(ref, (docSnap) => {
    horaSelect.innerHTML = "";
    let reservados = [];

    if(docSnap.exists()){
      reservados = docSnap.data().horarios || [];
    }

    horariosBase.forEach(h=>{
      if(!reservados.includes(h)){
        const opt = document.createElement("option");
        opt.value = h;
        opt.textContent = h;
        horaSelect.appendChild(opt);
      }
    });

    if(horaSelect.innerHTML === ""){
      horaSelect.innerHTML = "<option>Sem horários disponíveis</option>";
    }
  });
}

window.agendar = async function(){
  const nome = document.getElementById("nome").value;
  const data = dataInput.value;
  const hora = horaSelect.value;

  if(!nome || !data || !hora || hora==="Sem horários disponíveis"){
    document.getElementById("msg").innerText = "Preencha todos os campos corretamente";
    return;
  }

  const ref = doc(db, "reservas", data);
  const snap = await getDoc(ref);

  let horarios = [];

  if(snap.exists()){
    horarios = snap.data().horarios || [];
  }

  if(horarios.includes(hora)){
    document.getElementById("msg").innerText = "Esse horário já foi reservado.";
    return;
  }

  horarios.push(hora);

  await setDoc(ref, { horarios });

  document.getElementById("msg").innerText = "Agendado com sucesso para "+data+" às "+hora+" ⏰";
};
</script>
